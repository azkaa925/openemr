{#
TeletonicMD Custom Login Layout
Professional Medical Login Interface with Enhanced Accessibility

This template extends the base login template and applies the TeletonicMD design system
while maintaining ALL existing security features, CSRF protection, and authentication logic.

@package   OpenEMR
@author    TeletonicMD Design System
@copyright 2025 TeletonicMD
@license   GNU General Public License 3
@security  MAINTAINS ALL OPENEMR SECURITY FEATURES - UI ONLY MODIFICATIONS
#}

{% extends "login/base.html.twig" %}

{#
SECURITY CRITICAL: This template only modifies presentation layer.
All security headers, session management, and authentication logic remain unchanged.
#}

{% block title %}{{ title|text }} - Medical Portal Login{% endblock %}

{% block head %}
    {# Custom TeletonicMD Design System Integration #}
    <link rel="stylesheet" href="../themes/teletonic_custom/main.css">

    {# Medical Professional Favicon #}
    <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicon-16x16.png">

    {# Mobile Optimization #}
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#1e7a9a">

    {# Accessibility Enhancements #}
    <meta name="description" content="TeletonicMD Medical Portal - Secure Healthcare Professional Login">
{% endblock %}

{% block css %}
{{ parent() }}
<style>
/**
 * TeletonicMD Login Interface Styles
 * Professional Medical Authentication Interface
 * SECURITY: Styles only - no authentication logic modified
 */

/* Override base template styles with design system */
.band,
.box,
.vertical-band {
    background-color: var(--color-neutral-50) !important;
}

/* Professional Medical Login Container */
.teletonicmd-login-container {
    min-height: 100vh;
    background: linear-gradient(135deg, var(--color-primary-50) 0%, var(--color-secondary-50) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
}

/* Main Login Card */
.teletonicmd-login-card {
    background: white;
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-xl);
    overflow: hidden;
    width: 100%;
    max-width: 480px;
    /* SECURITY: Maintain form behavior */
    position: relative;
}

/* Medical Branding Header */
.teletonicmd-login-header {
    background: linear-gradient(135deg, var(--color-primary-600) 0%, var(--color-primary-700) 100%);
    color: white;
    padding: var(--space-8) var(--space-6) var(--space-6);
    text-align: center;
    position: relative;
}

.teletonicmd-login-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3e%3cg fill='none' fill-rule='evenodd'%3e%3cg fill='%23ffffff' fill-opacity='0.05'%3e%3cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3e%3c/g%3e%3c/g%3e%3c/svg%3e") repeat;
    opacity: 0.1;
}

.teletonicmd-logo-section {
    position: relative;
    z-index: 1;
}

.teletonicmd-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--space-2);
    color: white;
}

.teletonicmd-subtitle {
    font-size: var(--font-size-sm);
    opacity: 0.9;
    margin-bottom: 0;
}

/* Form Container */
.teletonicmd-form-container {
    padding: var(--space-8) var(--space-6) var(--space-6);
}

/* Enhanced Form Styling - SECURITY: Only visual changes */
.teletonicmd-form-group {
    margin-bottom: var(--space-6);
    position: relative;
}

.teletonicmd-form-group:last-child {
    margin-bottom: 0;
}

.teletonicmd-label {
    display: block;
    font-weight: var(--font-weight-medium);
    color: var(--color-neutral-700);
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-2);
    /* Accessibility: Required field indicator */
}

.teletonicmd-label.required::after {
    content: ' *';
    color: var(--color-error-500);
}

/* SECURITY CRITICAL: Input styling only - no validation changes */
.teletonicmd-input {
    width: 100%;
    height: var(--height-12);
    padding: 0 var(--space-4);
    font-family: var(--font-family-primary);
    font-size: var(--font-size-base);
    line-height: var(--line-height-normal);
    color: var(--color-neutral-900);
    background-color: white;
    border: var(--border-width-2) solid var(--color-neutral-300);
    border-radius: var(--border-radius-lg);
    transition: all 150ms ease-in-out;
    /* SECURITY: Maintain all form functionality */
}

.teletonicmd-input:focus {
    outline: none;
    border-color: var(--color-primary-500);
    box-shadow: var(--shadow-focus);
    /* Accessibility: Enhanced focus indicator */
}

.teletonicmd-input:disabled {
    background-color: var(--color-neutral-100);
    border-color: var(--color-neutral-200);
    color: var(--color-neutral-500);
    cursor: not-allowed;
}

.teletonicmd-input.error {
    border-color: var(--color-error-500);
}

.teletonicmd-input.error:focus {
    border-color: var(--color-error-500);
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

/* Password Input with Toggle */
.teletonicmd-password-container {
    position: relative;
}

.teletonicmd-password-toggle {
    position: absolute;
    right: var(--space-3);
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--color-neutral-400);
    cursor: pointer;
    padding: var(--space-1);
    border-radius: var(--border-radius-sm);
    transition: color 150ms ease-in-out;
    /* Accessibility: Focus indicator for toggle button */
}

.teletonicmd-password-toggle:hover {
    color: var(--color-neutral-600);
}

.teletonicmd-password-toggle:focus {
    outline: none;
    color: var(--color-primary-500);
    box-shadow: 0 0 0 2px var(--color-primary-200);
}

/* Select Dropdown Styling */
.teletonicmd-select {
    width: 100%;
    height: var(--height-12);
    padding: 0 var(--space-8) 0 var(--space-4);
    font-family: var(--font-family-primary);
    font-size: var(--font-size-base);
    color: var(--color-neutral-900);
    background-color: white;
    border: var(--border-width-2) solid var(--color-neutral-300);
    border-radius: var(--border-radius-lg);
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right var(--space-3) center;
    background-repeat: no-repeat;
    background-size: 1rem;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    transition: all 150ms ease-in-out;
}

.teletonicmd-select:focus {
    outline: none;
    border-color: var(--color-primary-500);
    box-shadow: var(--shadow-focus);
}

/* Professional Login Button - SECURITY: Maintains all form submission logic */
.teletonicmd-login-btn {
    width: 100%;
    height: var(--height-12);
    background: linear-gradient(135deg, var(--color-primary-500) 0%, var(--color-primary-600) 100%);
    border: none;
    border-radius: var(--border-radius-lg);
    color: white;
    font-family: var(--font-family-primary);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    cursor: pointer;
    transition: all 150ms ease-in-out;
    position: relative;
    overflow: hidden;
    /* SECURITY: All form functionality preserved */
}

.teletonicmd-login-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--color-primary-600) 0%, var(--color-primary-700) 100%);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.teletonicmd-login-btn:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: var(--shadow-sm);
}

.teletonicmd-login-btn:focus {
    outline: none;
    box-shadow: var(--shadow-focus);
}

.teletonicmd-login-btn:disabled {
    background: var(--color-neutral-300);
    color: var(--color-neutral-500);
    cursor: not-allowed;
    transform: none;
}

/* Loading State */
.teletonicmd-login-btn.loading {
    color: transparent;
}

.teletonicmd-login-btn.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 1.2rem;
    height: 1.2rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: translate(-50%, -50%) rotate(360deg);
    }
}

/* Alert Messages */
.teletonicmd-alert {
    padding: var(--space-3) var(--space-4);
    border-radius: var(--border-radius-md);
    border: var(--border-width-1) solid;
    margin-bottom: var(--space-4);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
}

.teletonicmd-alert-error {
    background-color: var(--color-error-50);
    border-color: var(--color-error-200);
    color: var(--color-error-800);
}

.teletonicmd-alert-info {
    background-color: var(--color-info-50);
    border-color: var(--color-info-200);
    color: var(--color-info-800);
}

/* HIPAA Compliance Notice */
.teletonicmd-hipaa-notice {
    position: fixed;
    bottom: var(--space-4);
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-neutral-900);
    color: white;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--border-radius-lg);
    font-size: var(--font-size-xs);
    text-align: center;
    max-width: 90%;
    box-shadow: var(--shadow-lg);
    z-index: 1000;
}

/* Responsive Design */
@media (max-width: 480px) {
    .teletonicmd-login-container {
        padding: var(--space-2);
    }

    .teletonicmd-login-card {
        max-width: none;
    }

    .teletonicmd-login-header,
    .teletonicmd-form-container {
        padding: var(--space-6) var(--space-4);
    }

    .teletonicmd-title {
        font-size: var(--font-size-xl);
    }
}

/* High Contrast Mode Support */
@media (prefers-contrast: high) {
    .teletonicmd-input,
    .teletonicmd-select {
        border-width: var(--border-width-2);
    }

    .teletonicmd-login-btn {
        border: var(--border-width-2) solid var(--color-primary-700);
    }
}

/* Reduced Motion Support */
@media (prefers-reduced-motion: reduce) {
    .teletonicmd-input,
    .teletonicmd-select,
    .teletonicmd-login-btn {
        transition: none;
    }

    .teletonicmd-login-btn.loading::after {
        animation: none;
    }
}

/* Focus-visible polyfill support */
.teletonicmd-input:focus-visible,
.teletonicmd-select:focus-visible,
.teletonicmd-login-btn:focus-visible,
.teletonicmd-password-toggle:focus-visible {
    outline: 2px solid var(--color-primary-500);
    outline-offset: 2px;
}
</style>
{% endblock %}

{% block content %}
{#
SECURITY CRITICAL: This block contains the entire login interface.
All security features are maintained through existing partials and form structure.
Only visual presentation is modified - NO authentication logic changes.
#}

{# Skip Link for Accessibility #}
<a href="#login-form" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:bg-blue-600 focus:text-white focus:px-4 focus:py-2 focus:rounded-md focus:z-50">
    Skip to login form
</a>

<div class="teletonicmd-login-container">
    <div class="teletonicmd-login-card">
        {# Medical Professional Branding Header #}
        <div class="teletonicmd-login-header">
            <div class="teletonicmd-logo-section">
                {% if displayPrimaryLogo and primaryLogo %}
                    <div class="mb-4">
                        <img src="{{ primaryLogo.src }}"
                             alt="{{ primaryLogo.alt|default('TeletonicMD Logo')|text }}"
                             class="max-h-12 mx-auto"
                             width="{{ primaryLogo.width|default(120) }}"
                             height="{{ primaryLogo.height|default(48) }}">
                    </div>
                {% endif %}

                <h1 class="teletonicmd-title">
                    {% if showTitleOnLogin %}
                        {{ title|text }}
                    {% else %}
                        TeletonicMD Portal
                    {% endif %}
                </h1>

                {% if displayTagline and tagline %}
                    <p class="teletonicmd-subtitle">{{ tagline|text }}</p>
                {% else %}
                    <p class="teletonicmd-subtitle">Secure Medical Professional Access</p>
                {% endif %}
            </div>
        </div>

        {# Main Form Container #}
        <div class="teletonicmd-form-container">
            {# Small Logo Display (if configured) #}
            {% if displaySmallLogo %}
                <div class="mb-6 text-center">
                    {% include "login/partials/html/small_logo.html.twig" %}
                </div>
            {% endif %}

            {# Relogin Notice #}
            {% if relogin %}
                <div class="teletonicmd-alert teletonicmd-alert-info" role="alert" aria-live="polite">
                    <strong>Session Expired:</strong> Please log in again to continue your secure session.
                </div>
            {% endif %}

            {# Login Failure Message #}
            {% if loginFail %}
                <div class="teletonicmd-alert teletonicmd-alert-error" role="alert" aria-live="assertive">
                    <strong>Login Failed:</strong> Invalid credentials. Please verify your username and password.
                </div>
            {% endif %}

            {#
            SECURITY CRITICAL: Form element maintains ALL existing security features
            - CSRF protection through hidden inputs
            - Session management
            - All authentication parameters
            - Security headers preserved
            #}
            <form method="POST"
                  id="login-form"
                  autocomplete="off"
                  action="../main/main_screen.php?auth=login&site={{ siteID|attr_url }}"
                  target="_top"
                  name="login_form"
                  novalidate>

                {# SECURITY: Hidden inputs for session management and CSRF protection #}
                <input type="hidden" name="new_login_session_management" value="1">
                <input type="hidden" name="languageChoice" value="{{ defaultLangID|attr }}">

                {# Username Field - Enhanced Accessibility #}
                <div class="teletonicmd-form-group">
                    <label for="authUser" class="teletonicmd-label required">
                        {{ "Username"|xlt }}
                    </label>
                    <input type="text"
                           id="authUser"
                           name="authUser"
                           class="teletonicmd-input"
                           required
                           autocomplete="username"
                           aria-describedby="username-help"
                           aria-invalid="false"
                           placeholder="Enter your username">
                    <div id="username-help" class="sr-only">
                        Enter your assigned medical professional username
                    </div>
                </div>

                {# Password Field with Toggle - Enhanced Security UX #}
                <div class="teletonicmd-form-group">
                    <label for="clearPass" class="teletonicmd-label required">
                        {{ "Password"|xlt }}
                    </label>
                    <div class="teletonicmd-password-container">
                        <input type="password"
                               id="clearPass"
                               name="clearPass"
                               class="teletonicmd-input"
                               required
                               autocomplete="current-password"
                               aria-describedby="password-help"
                               aria-invalid="false"
                               placeholder="Enter your password">
                        <button type="button"
                                id="password-icon"
                                class="teletonicmd-password-toggle"
                                aria-label="Toggle password visibility"
                                tabindex="0">
                            <i class="fa fa-eye" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div id="password-help" class="sr-only">
                        Enter your secure password
                    </div>
                </div>

                {# Application Selection (if enabled) - SECURITY: Maintains existing logic #}
                {{ divApp|raw }}

                {# Language Selection (if enabled) #}
                {% if displayLanguage %}
                    <div class="teletonicmd-form-group">
                        <label for="languageChoice" class="teletonicmd-label">
                            {{ "Language"|xlt }}
                        </label>
                        <select id="languageChoice"
                                name="languageChoice"
                                class="teletonicmd-select"
                                aria-describedby="language-help">
                            {% for language in languageList %}
                                <option value="{{ language.lang_id|attr }}"
                                        {% if language.lang_id == defaultLangID %}selected{% endif %}>
                                    {{ language.trans_lang_description|text }}
                                </option>
                            {% endfor %}
                        </select>
                        <div id="language-help" class="sr-only">
                            Select your preferred interface language
                        </div>
                    </div>
                {% endif %}

                {# Facility Selection (if enabled) - SECURITY: Maintains existing logic #}
                {% if displayFacilities %}
                    <div class="teletonicmd-form-group">
                        <label for="facility" class="teletonicmd-label">
                            {{ "Facility"|xlt }}
                        </label>
                        <select id="facility"
                                name="facility"
                                class="teletonicmd-select"
                                aria-describedby="facility-help">
                            {% for facility in facilityList %}
                                <option value="{{ facility.id|attr }}"
                                        {% if facility.id == facilitySelected %}selected{% endif %}>
                                    {{ facility.name|text }}
                                </option>
                            {% endfor %}
                        </select>
                        <div id="facility-help" class="sr-only">
                            Select the medical facility for this login session
                        </div>
                    </div>
                {% endif %}

                {# Login Button - SECURITY: Maintains all form submission logic #}
                <div class="teletonicmd-form-group">
                    <button type="submit"
                            id="login-button"
                            class="teletonicmd-login-btn"
                            aria-describedby="login-help">
                        {{ "Login"|xlt }}
                    </button>
                    <div id="login-help" class="sr-only">
                        Click to securely log into the medical portal
                    </div>
                </div>

                {# Google Sign-in Integration (if enabled) - SECURITY: Maintains existing logic #}
                {% if displayGoogleSignin %}
                    <div class="teletonicmd-form-group">
                        <input type="hidden" id="used-google-signin" name="used_google_signin" value="">
                        <input type="hidden" id="google-signin-token" name="google_signin_token" value="">
                        <div id="google-signin" onclick="return do_google_signin();" class="text-center">
                            <span id="google-signin-service-unreachable-alert" style="display:none;" class="text-red-600">
                                {{ "Google Sign-In is enabled but the service is unreachable."|xlt }}
                            </span>
                        </div>
                        <div id="google-signout" class="text-center mt-2" style="display:none;">
                            <a href="#" onclick="signOut();" class="text-sm text-blue-600 hover:text-blue-800">
                                {{ "Sign out"|xlt }}
                            </a>
                        </div>
                    </div>
                {% endif %}
            </form>

            {# Acknowledgments (if enabled) #}
            {% if displayAck %}
                <div class="mt-6 pt-4 border-t border-gray-200">
                    {% include "login/partials/html/acknowledgements.html.twig" %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

{# HIPAA Compliance Notice #}
<div class="teletonicmd-hipaa-notice" role="contentinfo">
    <i class="fa fa-shield-alt mr-1" aria-hidden="true"></i>
    HIPAA Compliant & Secure Medical Portal
</div>

{# Enhanced JavaScript for Modern UX - SECURITY: No authentication logic modified #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict';

    // SECURITY: All existing password toggle functionality preserved
    const passInput = document.getElementById('clearPass');
    const toggle = document.getElementById('password-icon');

    if (passInput && toggle) {
        toggle.addEventListener('click', function() {
            const isPassword = passInput.getAttribute('type') === 'password';
            passInput.setAttribute('type', isPassword ? 'text' : 'password');

            const icon = this.querySelector('i');
            if (icon) {
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            }

            // Update ARIA label for accessibility
            this.setAttribute('aria-label',
                isPassword ? 'Hide password' : 'Show password'
            );
        });

        // Keyboard support for password toggle
        toggle.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    }

    // Form submission loading state - SECURITY: Only UI enhancement
    const form = document.getElementById('login-form');
    const submitBtn = document.getElementById('login-button');

    if (form && submitBtn) {
        form.addEventListener('submit', function() {
            // Add loading state to button
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            // Update button text for screen readers
            submitBtn.setAttribute('aria-label', 'Logging in, please wait...');

            // Re-enable if form submission fails (network error, etc.)
            setTimeout(function() {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                submitBtn.setAttribute('aria-label', 'Login');
            }, 10000); // 10 second timeout
        });
    }

    // Enhanced error handling for accessibility
    const errorAlert = document.querySelector('.teletonicmd-alert-error');
    if (errorAlert) {
        // Focus management for error messages
        errorAlert.setAttribute('tabindex', '-1');
        errorAlert.focus();

        // Clear any previous error states
        const inputs = form.querySelectorAll('.teletonicmd-input');
        inputs.forEach(input => {
            input.classList.remove('error');
            input.setAttribute('aria-invalid', 'false');
        });
    }

    // Real-time validation feedback (visual only - no security impact)
    const usernameInput = document.getElementById('authUser');
    const passwordInput = document.getElementById('clearPass');

    [usernameInput, passwordInput].forEach(input => {
        if (input) {
            input.addEventListener('blur', function() {
                if (this.value.trim() === '') {
                    this.classList.add('error');
                    this.setAttribute('aria-invalid', 'true');
                } else {
                    this.classList.remove('error');
                    this.setAttribute('aria-invalid', 'false');
                }
            });

            input.addEventListener('input', function() {
                if (this.classList.contains('error') && this.value.trim() !== '') {
                    this.classList.remove('error');
                    this.setAttribute('aria-invalid', 'false');
                }
            });
        }
    });

    // Announce successful login for screen readers
    // SECURITY: Only accessibility enhancement - no auth logic change
    if (window.location.search.includes('login_success')) {
        const announcement = document.createElement('div');
        announcement.setAttribute('aria-live', 'polite');
        announcement.setAttribute('aria-atomic', 'true');
        announcement.className = 'sr-only';
        announcement.textContent = 'Login successful. Redirecting to medical portal dashboard.';
        document.body.appendChild(announcement);
    }
});
</script>
{% endblock %}

{% block post_content %}
{# Additional accessibility landmarks #}
<div id="aria-live-region" aria-live="polite" aria-atomic="true" class="sr-only"></div>
{% endblock %}